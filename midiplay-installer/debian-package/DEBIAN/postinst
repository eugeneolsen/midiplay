#!/bin/bash
# Post-installation script for midiplay

set -e

# Set proper permissions on the binary
chmod 755 /usr/local/bin/play

# Add /usr/local/bin to PATH if not already present
if ! echo "$PATH" | grep -q "/usr/local/bin"; then
    echo "Adding /usr/local/bin to system PATH..."
    
    # Add to /etc/environment if it exists
    if [ -f /etc/environment ]; then
        if ! grep -q "/usr/local/bin" /etc/environment; then
            sed -i 's|PATH="\(.*\)"|PATH="/usr/local/bin:\1"|' /etc/environment
        fi
    fi
fi

# Create symlink for common aliases mentioned in README
if [ ! -L /usr/local/bin/p ]; then
    ln -s /usr/local/bin/play /usr/local/bin/p
fi

# Create system configuration directory
if [ ! -d /etc/midiplay ]; then
    mkdir -p /etc/midiplay
    chmod 755 /etc/midiplay
fi

# Install default YAML configuration - it's already there from package installation
if [ -f /etc/midiplay/midi_devices.yaml ]; then
    chmod 644 /etc/midiplay/midi_devices.yaml
    echo "‚úÖ Default MIDI device configuration installed to /etc/midiplay/midi_devices.yaml"
else
    echo "‚ö†Ô∏è  Warning: YAML configuration file not found"
fi

# Print installation success message
echo ""
echo "‚úÖ Organ Pi MIDI File Player (midiplay) installed successfully!"
echo ""
echo "Usage: play <filename> [options]"
echo "   or: p <filename> [options]"
echo ""
echo "For help: play --version"
echo "Version: $(play --version 2>/dev/null || echo '1.5.0')"
echo ""
echo "üìÅ Configuration directory: /etc/midiplay/"
echo "   System config: /etc/midiplay/midi_devices.yaml"
echo "   User config:   ~/.config/midiplay/midi_devices.yaml (optional override)"
echo ""
echo "Note: Connect your MIDI device before running the player."
echo ""

exit 0